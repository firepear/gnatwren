<html>
  <head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.0.2/echarts.min.js" integrity="sha512-t9GZbGKCH5MuYUFsq5AdrhllT0kdnc2fNMizKDgLXBBXgHP2dXxjRPOzYJauAXW9OXLlSYELUqWD30k7cb0Mkg==" crossorigin="anonymous"></script>
    <style>
      body {background-color: #aaa; font-family: sans-serif; }
      .chart { background-color: #fff; border: medium solid #69f; border-radius: 10px;
               margin-left: 5%; margin-right: 5%; margin-bottom: 1%; padding: 10px;
               width: 90%; }
    </style>
  </head>
  <body>
    <div class="chart" id="cputemps" style="height:350px;"></div>
    <div class="chart" id="cputemps">
      <p>Foo.</p>
    </div>
  </body>
  <script>
    var nodes = ["node01", "node02", "node03", "node04", "node05", "node06",
                 "nodepi01", "nodepi02", "nodepi03", "nodepi04"];
    var cpuTReq = new XMLHttpRequest();
    cpuTReq.addEventListener("load", plotCPUTemps);

    function plotCPUTemps() {
        // reset cpuT.series and dimensions
        cpuT.series = [];
        cpuT.dataset.dimensions = ['timestamp'];
        // create a hash for last-known temps and initazlize it to nulls
        var tl = {};
        for (let node in nodes) {
            tl[nodes[node]] = null;
            // also, while we're here, rebuild cpuT.series and dimensions
            cpuT.series.push({name: nodes[node], type: 'line', showSymbol: false, encode: {x: 'timestamp', y: nodes[node]}});
            cpuT.dataset.dimensions.push(nodes[node]);
        }

        // vivify the data we just fetched
        var temps_in = JSON.parse(this.responseText);
        // iterate over it
        for (let ts in temps_in) {
            var curData = [ts * 1000];
            for (let node in nodes) {
                var host = nodes[node];
                if (host in temps_in[ts]) {
                    tl[host] = temps_in[ts][host];
                    curData.push(temps_in[ts][host]);
                } else {
                    curData.push(tl[host]);
                }
            }
            cpuT.dataset.source.push(curData);
        }
        // apply and render
        cpuT && cpuTChart.setOption(cpuT);
    }

    function getCPUTemps() {
        cpuTReq.open("GET", "http://localhost:9099/gnatwren/cputemps.json");
        cpuTReq.send();
    }

    // one of these for every chart
    var cpuTDom = document.getElementById('cputemps');
    var cpuTChart = echarts.init(cpuTDom);
    var cpuT;
    // set options
    cpuT = {
        title: { text: 'CPU Temperatures, last hour' },
        tooltip: { trigger: 'axis' },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'time', boundaryGap: ['20%', '20%'], min: 'dataMin', max: 'dataMax' },
        yAxis: { type: 'value', min: 'dataMin' },
        // the following values will change over time
        //legend: { data: ['node01', 'node02', 'node03'] },
        series: [],
        dataset: {
            // timestamps are in milliseconds; multiply by 1000 from DB
            source: [],
            //[ 1616359143000, 1, 2, 3 ],
            dimensions: ['timestamp']
        }
    };
    // apply and render
    getCPUTemps();
  </script>
</html>
